<!-- Created by Michael Simms -->
<!-- Copyright (c) 2025 Michael Simms -->

<!DOCTYPE html>
<html lang="en-US">

<head>

<title>Dashboard</title>

<link rel="stylesheet" type="text/css" href="${root_url}/css/normalize.css">
<link rel="stylesheet" type="text/css" href="${root_url}/css/site.css">
<link rel="stylesheet" type="text/css" href="${root_url}/css/gauges.css">
<link rel="stylesheet" type="text/css" href="${root_url}/css/graphs.css">
<link rel="shortcut icon" href="${root_url}/media/favicon.ico">

<meta charset="UTF-8">

</head>

<body>

<!-- Gauges Start -->
<div id="gauges" class="block">
    <div>
        <h3>Indoor CO<sup>2</sup></h3>
        <canvas id="indoor-co2-gauge"></canvas>
    </div>
</div>
<!-- Gauges End -->

<!-- Graphs Start -->
<div id="charts" class="charts">
</div>
<!-- Graphs End -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js" integrity="sha512-RJJ1NNC88QhN7dwpCY8rm/6OxI+YdQP48DrLGe/eSAd+n+s1PXwQkkpzzAgoJe4cZFW2GALQoxox61gSY2yQfg==" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
<script src="${root_url}/js/common.js"></script>
<script src="${root_url}/js/graphs.js"></script>
<script>

    var g_co2_guage = null;

    /// @function draw_co2_gauge
    /// Creates a co2 gauge.
    function draw_co2_gauge(element_id) {
        // Gauge options
        var opts = {
            angle: 0.15, // Span of the gauge arc (0 = full circle, 0.15 ~ half circle)
            lineWidth: 0.25, // Relative thickness
            radiusScale: 1.0,

            pointer: {
                length: 0.7, // Relative to gauge radius
                strokeWidth: 0.04,
                color: "#aaaaaa"
            },

            // Background zones for the arc
            staticZones: [
                { strokeStyle: "#30B32D", min: 0,    max: 800 },  // Green
                { strokeStyle: "#FFDD00", min: 800,  max: 1500 }, // Yellow
                { strokeStyle: "#F03E3E", min: 1500, max: 2000 }  // Red
            ],

            // Value labels around the arc
            staticLabels: {
                font: "12px sans-serif",
                labels: [0, 400, 800, 1200, 1600, 2000],
                color: "#aaaaaa",
                fractionDigits: 0
            },

            // Style of the remaining (unused) arc
            strokeColor: "#E0E0E0",
            limitMax: true,
            limitMin: true,
            highDpiSupport: true
        };

        var target = document.getElementById(element_id);
        var gauge  = new Gauge(target).setOptions(opts);

        // Configure the range.
        gauge.maxValue = 2000;
        gauge.setMinValue(0);
        gauge.animationSpeed = 32;

        return gauge;
    }

    /// @function fetch_more_graph_data
    function fetch_more_graph_data(settings, min_x, max_x) {
        if (settings.element_id == "co2_chart" || settings.element_id == "temp_chart" || settings.element_id == "humidity_chart" ||
            element_id == "voc_chart" || element_id == "voc_index_chart") {
            get_indoor_air_quality_readings(min_x / 1000.0, settings);
        }
        else if (settings.element_id == "temperature" || settings.element_id == "humidity" ||
            settings.element_id == "moisture_sensor_1" || settings.element_id == "moisture_sensor_2") {
            get_patio_monitor_readings(min_x / 1000.0, settings);
        }
    }

    /// @function create_graph_settings
    function create_graph_settings(element_id, label, unit_label, color, height) {
        var settings = new GraphSettings();
        settings.element_id = element_id;
        settings.label = label;
        settings.unit_label = unit_label;
        settings.color = color;
        settings.height = height;
        settings.fill = false;
        settings.more_data_func = fetch_more_graph_data;
        return settings;
    }

    /// @function get_indoor_air_quality_readings
    function get_indoor_air_quality_readings(start_ts, graph_settings) {
        let api_url = "${root_url}/api/1.0/indoor_air?start_ts=" + start_ts

        send_get_request_async(api_url, function (response_code, response_text) {
            if (response_code == 200) {
                const CHART_HEIGHT = 250;
                const records = JSON.parse(response_text);

                var co2_readings = [];
                var temp_readings = [];
                var humidity_readings = [];
                var voc_readings = [];
                var voc_index_readings = [];

                for (let record of records) {
                    let ts = record['ts'];
                    co2_readings.push( { x: ts, y: record['co2_ppm'] });
                    temp_readings.push( { x: ts, y: record['temp_c'] });
                    humidity_readings.push( { x: ts, y: record['humidity'] });
                    voc_readings.push( { x: ts, y: record['voc'] });
                    voc_index_readings.push( { x: ts, y: record['voc_index'] });
                }

                if (co2_readings.length > 0) {
                    if (graph_settings == null) {
                        draw_graph(co2_readings, create_graph_settings("co2_chart", "Indoor CO2", "PPM", "yellow", CHART_HEIGHT));
                    }
                    else {
                        graph_settings.update_func(co2_readings);
                    }
                    g_co2_guage.set(co2_readings.at(-1).y);
                }
                if (temp_readings.length > 0) {
                    if (graph_settings == null) {
                        draw_graph(temp_readings, create_graph_settings("temp_chart", "Indoor Temperature", "C", "red", CHART_HEIGHT));
                    }
                    else {
                        graph_settings.update_func(co2_readings);
                    }
                }
                if (humidity_readings.length > 0) {
                    if (graph_settings == null) {
                        draw_graph(humidity_readings, create_graph_settings("humidity_chart", "Indoor Humidity", "%", "blue", CHART_HEIGHT));
                    }
                    else {
                        graph_settings.update_func(co2_readings);
                    }
                }
                if (voc_readings.length > 0) {
                    if (graph_settings == null) {
                        draw_graph(voc_readings, create_graph_settings("voc_chart", "VOC", "", "green", CHART_HEIGHT));
                    }
                    else {
                        graph_settings.update_func(co2_readings);
                    }
                }
                if (voc_index_readings.length > 0) {
                    if (graph_settings == null) {
                        draw_graph(voc_index_readings, create_graph_settings("voc_index_chart", "VOC Index", "", "green", CHART_HEIGHT));
                    }
                    else {
                        graph_settings.update_func(co2_readings);
                    }
                }
            }
        });
    }

    /// @function get_patio_monitor_readings
    function get_patio_monitor_readings(start_ts, graph_settings) {
        let api_url = "${root_url}/api/1.0/patio?start_ts=" + start_ts

        send_get_request_async(api_url, function (response_code, response_text) {
            if (response_code == 200) {
                const records = JSON.parse(response_text);
                var temp_readings = [];
                var humidity_readings = [];
                var moisture_sensor_1_readings = [];
                var moisture_sensor_2_readings = [];

                for (let record of records) {
                    let ts = record['ts'];
                    temp_readings.push( { x: ts, y: record['temperature'] });
                    humidity_readings.push( { x: ts, y: record['humidity'] });
                    moisture_sensor_1_readings.push( { x: ts, y: record['moisture_sensor_1'] });
                    moisture_sensor_2_readings.push( { x: ts, y: record['moisture_sensor_2'] });
                }

                if (temp_readings.length > 0) {
                    if (graph_settings == null) {
                        draw_graph(temp_readings, create_graph_settings("temp_chart", "Patio Temperature", "C", "red", 250));
                    }
                    else {
                        graph_settings.update_func(co2_readings);
                    }
                }
                if (humidity_readings.length > 0) {
                    if (graph_settings == null) {
                        draw_graph(humidity_readings, create_graph_settings("humidity_chart", "Patio Humidity", "%", "blue", 250));
                    }
                    else {
                        graph_settings.update_func(co2_readings);
                    }
                }
                if (moisture_sensor_1_readings.length > 0) {
                    if (graph_settings == null) {
                        draw_graph(moisture_sensor_1_readings, create_graph_settings("moisture_sensor_1_chart", "Moisture Sensor #1", "%", "green", 250));
                    }
                    else {
                        graph_settings.update_func(co2_readings);
                    }
                }
                if (moisture_sensor_2_readings.length > 0) {
                    if (graph_settings == null) {
                        draw_graph(moisture_sensor_2_readings, create_graph_settings("moisture_sensor_2_chart", "Moisture Sensor #2", "%", "green", 250));
                    }
                    else {
                        graph_settings.update_func(co2_readings);
                    }
                }
            }
        });
    }

    /// @function get_website_status
    function get_website_status(start_ts, graph_settings) {
        let api_url = "${root_url}/api/1.0/website_status?start_ts=" + start_ts

        send_get_request_async(api_url, function (response_code, response_text) {
            if (response_code == 200) {
                const records = JSON.parse(response_text);
                var graphs = {};

                records.forEach(record => {
                    let ts = record.ts;
                    for (const [key, value] of Object.entries(record)) {
                        if (key != 'ts') {
                            if (is_numeric(value.load_time_secs)) {
                                let new_item = {'x': ts, 'y': value.load_time_secs};
                                if (key in graphs) {
                                    graphs[key].push(new_item);
                                }
                                else {
                                    graphs[key]= [new_item];
                                }
                            }
                        }
                    }
                });

                for (const [key, value] of Object.entries(graphs)) {
                    draw_graph(value, create_graph_settings(key, key, "Load Time (s)", "gray", 250));
                };
            }
        });
    }
    
    /// @function get_readings
    function get_readings() {
        var yesterday = new Date(new Date().getTime() - (24 * 60 * 60 * 1000));
        var yesterday_ts = Math.floor(yesterday.getTime() / 1000.0);

        get_indoor_air_quality_readings(yesterday_ts, null);
        get_patio_monitor_readings(yesterday_ts, null);
        get_website_status(yesterday_ts, null);
    }


    g_co2_guage = draw_co2_gauge("indoor-co2-gauge");
    g_co2_guage.set(0);

    get_readings();

</script>

</body>

</html>
